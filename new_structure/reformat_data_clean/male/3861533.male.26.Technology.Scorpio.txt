hallvard vassbotn shows blog delphi interface retrieve implementing object awesome new solution put usenet news already know way see later hallvards way cleaner even cool function getimplementingobject const ainterface iinterface tobject const addbyte opcode add dword ptr esp shortint addlong opcode add dword ptr esp longint type padjustselfthunk tadjustselfthunk tadjustselfthunk packed record case addinstruction longint addbyte adjustmentbyte shortint addlong adjustmentlong longint end pinterfacemt tinterfacemt tinterfacemt packed record queryinterfacethunk padjustselfthunk end tinterfaceref pinterfacemt var queryinterfacethunk padjustselfthunk begin result pointer ainterface assigned result try queryinterfacethunk tinterfaceref ainterface queryinterfacethunk case queryinterfacethunk addinstruction addbyte inc pchar result queryinterfacethunk adjustmentbyte addlong inc pchar result queryinterfacethunk adjustmentlong else result nil end except result nil end end explaining method quoting hallvard another usenet post hack relies fact interfaces inherit iinterface first method always queryinterface qi always stdcall free implement static virtual dynamic method luckily three cases thunks identical prologue code adjust self pointer stack adjustment constant fit byte shortint might take entire longint depends size parent class check two cases pick correct self adjustment field general case compiler actually creates slightly different kinds thunks tree dimensions offset interface method table imt object instance shortint longint calling convention stack based esp stdcall cdecl pascal safecall register based eax static virtual dynamic interfaces cannot declare message methods thunks virtual dynamic register methods particularly interesting code cannot modify registers old way function getimplementingobject const ainstance iunknown const aguid tguid const aimplclass tclass tobject var linterfaceentry pinterfaceentry begin result nil aimplclass nil ainstance nil begin exit end linterfaceentry aimplclass getinterfaceentry aguid assigned linterfaceentry begin linterfaceentry ioffset begin result tobject integer ainstance linterfaceentry ioffset end end end seem current blogger theme quite cut posting source code